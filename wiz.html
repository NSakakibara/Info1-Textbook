<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法使いのポーション調合</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kiwi Maru', serif;
            touch-action: pan-y; /* 縦スクロールを許可し、ピンチズームは無効に */
        }
        .bg-magic {
            background-color: #1a202c;
            background-image: radial-gradient(circle, #3a3a5a 1px, transparent 1px);
            background-size: 1.5rem 1.5rem;
        }
        .ingredient {
            cursor: grab;
            transition: transform 0.2s ease-in-out;
            touch-action: auto; /* 材料の上ではタッチ操作をブラウザ標準に戻す */
        }
        .ingredient:active {
            cursor: grabbing;
            transform: scale(1.1);
            z-index: 10;
        }
        .recipe-scroll {
            background-color: #f5e8c7;
            border: 8px solid #a17a4a;
            border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z' fill='%23a17a4a'/%3E%3C/svg%3E") 8;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .ingredient {
            cursor: grab;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .ingredient:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 100, 0.7);
        }
        .dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        /* タッチ操作中のゴースト要素のスタイル */
        .dragging-touch {
            position: fixed; /* 画面に固定 */
            pointer-events: none; /* イベントを透過させる */
            z-index: 1000;
            opacity: 0.8;
            transform: scale(1.1);
        }
        /* ドラッグ元の要素を半透明にする */
        .opacity-30 {
            opacity: 0.3;
        }

        .cauldron-drop-zone.dragover {
            transform: scale(1.05);
            box-shadow: 0 0 30px 10px rgba(72, 255, 201, 0.7);
        }

        /* Animations */
        @keyframes sparkle {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
        .sparkle {
            position: absolute;
            width: 15px;
            height: 15px;
            background: gold;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle 0.7s ease-out;
        }

        @keyframes smoke {
            0% { transform: scale(0.5) translateY(0); opacity: 0; }
            50% { opacity: 0.6; }
            100% { transform: scale(1.5) translateY(-50px); opacity: 0; }
        }
        .smoke {
            position: absolute;
            width: 80px;
            height: 80px;
            background: #888;
            border-radius: 50%;
            pointer-events: none;
            animation: smoke 1s ease-out forwards;
        }
        @keyframes frog-jump {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            30% { transform: translateY(-80px) scale(1) rotate(-15deg); opacity: 1; }
            100% { transform: translateY(50px) scale(1.2) rotate(15deg); opacity: 0; }
        }
        .frog-jump {
            position: absolute;
            font-size: 4rem;
            pointer-events: none;
            animation: frog-jump 0.8s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-magic text-white min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="w-full max-w-5xl mx-auto text-center">
        <!-- Header -->
        <h1 class="text-4xl font-bold mb-2 text-yellow-300" style="text-shadow: 2px 2px 4px #000;">魔法使いのポーション調合</h1>
        <p class="text-lg mb-6">師匠のレシピ通りに、ポーションを完成させるのじゃ！</p>

        <div class="flex flex-col lg:flex-row gap-8 items-center justify-between">
            <!-- Recipe Section -->
            <div id="recipe-section" class="w-full lg:w-1/3">
                <h2 class="text-2xl font-bold mb-3 text-yellow-200">📜 魔法のレシピ</h2>
                <div class="recipe-scroll p-6 rounded-lg text-gray-800">
                    <ul id="recipe-list" class="text-left space-y-3">
                        <!-- Recipe items will be generated here -->
                    </ul>
                </div>
            </div>

            <!-- Cauldron Section -->
            <div id="cauldron-section" class="relative w-full lg:w-1/3 flex flex-col items-center">
                 <div id="animation-area" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>
                 <div class="cauldron-drop-zone w-48 h-40 bg-gray-800 border-4 border-gray-600 rounded-t-full rounded-b-lg flex items-center justify-center transition-all duration-300"
                    style="box-shadow: 0 10px 15px rgba(0,0,0,0.5) inset;">
                    <div class="w-40 h-32 bg-purple-800 rounded-t-full rounded-b-md opacity-75 relative overflow-hidden">
                       <div class="absolute bottom-0 left-0 w-full h-1/3 bg-purple-600 rounded-full animate-pulse"></div>
                    </div>
                </div>
                <div class="text-2xl mt-2">🧪 大鍋</div>
            </div>
        </div>

        <!-- Ingredients Shelf -->
        <div id="shelf-section" class="mt-10">
            <h2 class="text-2xl font-bold mb-4 text-yellow-200">🌿 材料棚</h2>
            <div id="ingredients-shelf" class="bg-yellow-900/50 p-4 rounded-lg grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-4 border-2 border-yellow-800">
                <!-- Ingredients will be generated here -->
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 border-4 border-yellow-500 rounded-lg p-8 text-center max-w-md w-full relative">
             <img src="https://placehold.co/100x100/7a4a2a/f5e8c7?text=🧙‍♂️" alt="師匠" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-yellow-300">
            <h2 id="modal-title" class="text-3xl font-bold mb-4 text-yellow-300"></h2>
            <p id="modal-message" class="text-lg mb-6"></p>
            <button id="restart-button" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-transform">もう一度挑戦</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Game Data ---
            const allIngredients = [
                // Correct ingredients pool
                { id: 'red-fire', name: '赤い液体', color: 'bg-red-500', symbol: '🔥', isCorrect: true },
                { id: 'green-leaf', name: '緑の粉', color: 'bg-green-500', symbol: '🍃', isCorrect: true },
                { id: 'blue-water', name: '青い液体', color: 'bg-blue-500', symbol: '💧', isCorrect: true },
                { id: 'yellow-star', name: '黄の結晶', color: 'bg-yellow-400', symbol: '⭐', isCorrect: true },
                { id: 'purple-moon', name: '紫の液体', color: 'bg-purple-500', symbol: '🌙', isCorrect: true },
                { id: 'orange-feather', name: '橙の羽根', color: 'bg-orange-500', symbol: '🪶', isCorrect: true },

                // Decoys
                { id: 'red-water', name: '赤黒い液体', color: 'bg-red-800', symbol: '💧' },
                { id: 'green-skull', name: '深緑の粉', color: 'bg-green-800', symbol: '💀' },
                { id: 'blue-moon', name: '藍色の液体', color: 'bg-blue-800', symbol: '🌙' },
                { id: 'yellow-skull', name: '黄土の結晶', color: 'bg-yellow-700', symbol: '💀' },
                { id: 'red-leaf', name: '暗い赤の液体', color: 'bg-red-700', symbol: '🍃' },
                { id: 'green-fire', name: '黄緑の粉', color: 'bg-lime-400', symbol: '🔥' },
                { id: 'purple-star', name: '濃紫の液体', color: 'bg-purple-800', symbol: '⭐' },
                { id: 'orange-skull', name: '濁った橙の粉', color: 'bg-orange-800', symbol: '💀' },
                { id: 'white-skull', name: '白い骨', color: 'bg-gray-200 text-black', symbol: '💀' },
                { id: 'black-fire', name: '黒い灰', color: 'bg-gray-900', symbol: '🔥' },
            ];

            let recipe = [];
            const RECIPE_LENGTH = 4; // Increased recipe length

            let currentStep = 0;
            let draggedIngredientId = null;

            // --- タッチ操作用の変数 ---
            let ghostElement = null;
            let isTouchDragging = false;
            let startTouchX = 0;
            let startTouchY = 0;

            // --- DOM Elements ---
            const recipeList = document.getElementById('recipe-list');
            const ingredientsShelf = document.getElementById('ingredients-shelf');
            const cauldronDropZone = document.querySelector('.cauldron-drop-zone');
            const animationArea = document.getElementById('animation-area');
            const resultModal = document.getElementById('result-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const restartButton = document.getElementById('restart-button');

            // --- Game Logic ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function generateRecipe() {
                const correctIngredients = allIngredients.filter(ing => ing.isCorrect);
                const shuffled = shuffleArray([...correctIngredients]);
                recipe = shuffled.slice(0, RECIPE_LENGTH);
            }

            function setupGame(isEasyMode = false) {
                currentStep = 0;
                draggedIngredientId = null;

                // Generate a new random recipe
                generateRecipe();

                // Render Recipe
                renderRecipe();

                // Render Ingredients
                ingredientsShelf.innerHTML = '';
                const shuffledIngredients = shuffleArray([...allIngredients]);
                shuffledIngredients.forEach(ing => {
                    const ingElement = document.createElement('div');
                    ingElement.id = ing.id;
                    ingElement.draggable = true;
                    ingElement.className = 'ingredient p-2 bg-gray-700 rounded-lg flex flex-col items-center justify-center aspect-square text-center';
                    
                    if (isEasyMode) {
                        // 通常モード：アイコンと文字を表示
                        ingElement.innerHTML = `
                            <div class="w-10 h-10 ${ing.color} rounded-full border-2 border-gray-400 flex items-center justify-center text-3xl mb-1">
                                ${ing.symbol}
                            </div>
                            <div class="text-xs leading-tight">${ing.name}</div>
                        `;
                    } else {
                        // 高難易度モード：色のみ表示
                        ingElement.innerHTML = `
                            <div class="w-full h-full ${ing.color} rounded-full border-2 border-gray-400">
                            </div>
                        `;
                    }

                    ingElement.addEventListener('dragstart', handleDragStart);
                    ingElement.addEventListener('dragend', handleDragEnd);

                    // --- モバイル用のタッチイベントを追加 ---
                    ingElement.addEventListener('touchstart', handleTouchStart, { passive: true }); // スクロールを妨げないよう passive: true

                    ingredientsShelf.appendChild(ingElement);
                });
                
                resultModal.classList.add('hidden');
            }

            function renderRecipe() {
                recipeList.innerHTML = '';
                recipe.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = `transition-all duration-300 p-2 rounded ${index < currentStep ? 'opacity-50 line-through' : ''} ${index === currentStep ? 'bg-yellow-200 font-bold' : ''}`;
                    li.innerHTML = `<span>${index + 1}. ${item.name} ${item.symbol}</span>`;
                    recipeList.appendChild(li);
                });
            }

            function handleIngredientDrop() {
                const requiredIngredient = recipe[currentStep];

                if (draggedIngredientId === requiredIngredient.id) {
                    // Correct ingredient
                    playSuccessAnimation();
                    currentStep++;
                    renderRecipe();

                    if (currentStep >= recipe.length) {
                        setTimeout(() => showGameResult(true), 500);
                    }
                } else {
                    // Incorrect ingredient
                    playFailureAnimation();
                    setTimeout(() => showGameResult(false), 500);
                }
            }
            
            function showGameResult(isSuccess) {
                if (isSuccess) {
                    modalTitle.textContent = '🎉 ポーション完成！ 🎉';
                    modalMessage.textContent = '素晴らしいポーションが完成したぞ！正しい材料を、正しい手順で使う。これが一流の魔法使いへの道じゃ！';
                    restartButton.textContent = 'もう一度挑戦';
                    restartButton.onclick = () => {
                        resultModal.classList.add('hidden');
                        setupGame(false); // 次も高難易度で挑戦
                    };
                } else {
                    modalTitle.textContent = '💥 調合失敗！ 💥';
                    modalMessage.textContent = '失敗じゃな。色だけで判断するのは難しいじゃろ？普段からラベルに文字やアイコンを追加して区別しやすくしておくのが大切なんじゃ。よし、今回は儂がラベルを追加してやろう。これで再挑戦してみるがよい！';
                    restartButton.textContent = 'ラベル付きで再挑戦';
                     restartButton.onclick = () => {
                        resultModal.classList.add('hidden');
                        setupGame(true); // 次は通常モードで挑戦
                    };
                }
                resultModal.classList.remove('hidden');
            }


            // --- Animations ---
            function playSuccessAnimation() {
                for (let i = 0; i < 15; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = `${Math.random() * 100}%`;
                    sparkle.style.top = `${Math.random() * 100}%`;
                    sparkle.style.animationDelay = `${Math.random() * 0.5}s`;
                    animationArea.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1000);
                }
            }
            
            function playFailureAnimation() {
                const failureType = Math.random() > 0.5 ? 'smoke' : 'frog';

                if (failureType === 'smoke') {
                    const smoke = document.createElement('div');
                    smoke.className = 'smoke';
                    animationArea.appendChild(smoke);
                    setTimeout(() => smoke.remove(), 1000);
                } else {
                    const frog = document.createElement('div');
                    frog.className = 'frog-jump';
                    frog.textContent = '🐸';
                    animationArea.appendChild(frog);
                    setTimeout(() => frog.remove(), 800);
                }
            }


            // --- Drag and Drop Event Handlers ---
            function handleDragStart(e) {
                if (isTouchDragging) { // タッチ操作中はマウスドラッグを無効化
                    e.preventDefault();
                    return;
                }
                draggedIngredientId = e.target.closest('.ingredient').id;
                e.target.closest('.ingredient').classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }

            function handleDragEnd(e) {
                if (isTouchDragging) return;
                e.target.closest('.ingredient').classList.remove('dragging');
            }
            
            cauldronDropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                cauldronDropZone.classList.add('dragover');
            });
            
            cauldronDropZone.addEventListener('dragover', (e) => {
                e.preventDefault(); // Necessary to allow drop
            });

            cauldronDropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                cauldronDropZone.classList.remove('dragover');
            });

            cauldronDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                cauldronDropZone.classList.remove('dragover');
                handleIngredientDrop();
            });
            
            // --- モバイル用タッチイベントのハンドラー ---

            function handleTouchStart(e) {
                if (e.touches.length !== 1) return; // マルチタッチは無視
                const ingElement = e.target.closest('.ingredient');
                if (!ingElement) return;

                // ドラッグ開始の準備
                draggedIngredientId = ingElement.id;
                const touch = e.touches[0];
                startTouchX = touch.clientX;
                startTouchY = touch.clientY;
                // isTouchDragging は move で判定する
            }

            function handleTouchMove(e) {
                if (!draggedIngredientId) return; // ドラッグが開始されていない
                if (e.touches.length !== 1) return; // マルチタッチ

                const touch = e.touches[0];

                if (!isTouchDragging) {
                    // 5px以上動いたらドラッグ開始とみなす
                    const deltaX = Math.abs(touch.clientX - startTouchX);
                    const deltaY = Math.abs(touch.clientY - startTouchY);

                    if (deltaX < 5 && deltaY < 5) {
                        return; // 移動量が少ない場合は何もしない
                    }

                    // ドラッグ開始
                    isTouchDragging = true;
                    
                    const ingElement = document.getElementById(draggedIngredientId);
                    if (!ingElement) return;

                    // 指に追従するゴースト要素を作成
                    ghostElement = ingElement.cloneNode(true);
                    ghostElement.classList.add('dragging-touch');
                    document.body.appendChild(ghostElement);
                    
                    // 元の要素を半透明に
                    ingElement.classList.add('opacity-30');
                }

                // ドラッグ中の処理
                if (isTouchDragging) {
                    // スクロールを防止
                    e.preventDefault();
                    
                    // ゴースト要素を指の位置に更新
                    updateGhostPosition(touch);

                    // 鍋の上にあるか判定
                    const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (elementAtPoint && elementAtPoint.closest('.cauldron-drop-zone')) {
                        cauldronDropZone.classList.add('dragover');
                    } else {
                        cauldronDropZone.classList.remove('dragover');
                    }
                }
            }

            function handleTouchEnd(e) {
                if (isTouchDragging && ghostElement) {
                    // ドラッグ終了時の処理
                    const touch = e.changedTouches[0];
                    const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
                    
                    if (elementAtPoint && elementAtPoint.closest('.cauldron-drop-zone')) {
                        // 鍋の上で指が離れた場合
                        handleIngredientDrop();
                    }

                    // クリーンアップ
                    document.body.removeChild(ghostElement);
                    ghostElement = null;
                    cauldronDropZone.classList.remove('dragover');
                    
                    const originalElement = document.getElementById(draggedIngredientId);
                    if (originalElement) {
                        originalElement.classList.remove('opacity-30');
                    }
                }

                // 状態をリセット
                isTouchDragging = false;
                draggedIngredientId = null;
                startTouchX = 0;
                startTouchY = 0;
            }

            function updateGhostPosition(touch) {
                 if (!ghostElement) return;
                 // ゴースト要素が指の中心に来るように調整
                 ghostElement.style.left = `${touch.clientX - ghostElement.offsetWidth / 2}px`;
                 ghostElement.style.top = `${touch.clientY - ghostElement.offsetHeight / 2}px`;
            }

            // --- Event Listeners ---
            // グローバルに touchmove と touchend を登録
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);


            // --- Initial Setup ---
            setupGame(false); // 最初は高難易度モードで開始
        });
    </script>
</body>
</html>





